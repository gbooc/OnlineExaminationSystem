var count = 0;
var answer = [];
var tmpAnswer = {};

function SubmitExam(isGoodBye, isSubmitted, isQuickExam) {
    // Examinee's duration
    var today = $("#dateToday").val();
    var timeStarted = new Date(today).getTime();
    var now = new Date().getTime();
    var distance = now - timeStarted;

    var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = Math.floor((distance % (1000 * 60)) / 1000);

    var duration = hours + "h " + minutes + "m " + seconds + "s";
    //---- E N D -----

    var max = $("#txtMax").val();
    var min = $("#txtMin").val();
    var examID = $("#TEtxtExamID").val();
    var empID = $("#EmpIDSession").val();

    var mcHasEmpty = 0;

    for (var i = 1; i <= max; i++) {
        var ans = "ans" + i;
        var error = "error" + i;
        var fieldName = $("#" + ans).attr('name');

        if (i >= min) {
            if ($("#" + ans).val() !== "") {

                var ansType = "";

                if ($("#" + ans).is(':radio')) {

                    if ($("input[name='" + fieldName + "']:checked").length > 0) {
                        var selectedVal = $("input[name='" + fieldName + "']:checked").val();
                        ansType = selectedVal;
                        mcHasEmpty++;

                        console.log(mcHasEmpty);
                    } else {
                        document.getElementById(ans).style.borderColor = "red";
                        $("#" + error).show();
                        mcHasEmpty = 0;
                    }

                } else {
                    ansType = $("#" + ans).val();
                }

                tmpAnswer = {
                    'ID': i,
                    'Answer': ansType,
                    'duration': duration
                };
                count++;
                answer.push(JSON.stringify(tmpAnswer));
            } else {

                if (isGoodBye == 0) {
                    document.getElementById(ans).style.borderColor = "red";
                    $("#" + error).show();
                    count--;
                } else {
                    var Ans = "";

                    if ($("#" + ans).val() == "") {
                        Ans = "No Answer";
                    } else {
                            Ans = ("#" + ans).val();
                    }

                    tmpAnswer = {
                        'ID': i,
                        'Answer': Ans,
                        'duration': duration
                    };
                    count++;
                    mcHasEmpty = count;
                    answer.push(JSON.stringify(tmpAnswer));
                }
            }
        }
    }


    if (count == answer.length && mcHasEmpty > 0) {

        $.ajax({
            url: '/Examinations/SubmitExam',
            type: 'POST',
            async: false,
            data: JSON.stringify({ ExamID: examID, EmpID: empID, Answer: answer }),
            dataType: "json",
            traditional: true,
            contentType: 'application/json;',
            cache: false,
            beforeSend: function () {
                $("#teOverlay").fadeIn();
            },
            success: function (result) {

                if (isSubmitted == 1) {
                    window.onbeforeunload = null;
                    window.onunload = null;
                }

                if (isQuickExam == 0) {
                    setTimeout(function () {
                        window.location.href = "/Examinations/OpenExamHistory?examId=" + result.examID + "&empID=" + result.empID + "#questionaires";
                    }, 5500);
                } else {
                    setTimeout(function () {
                        window.location.href = "/Examinations/AutoGeneratedList?code=" + result.controlNo;
                    }, 5500);
                }

            },
            complete: function () {
                setTimeout(function () {
                    $("#teOverlay").fadeOut();
                }, 5000);
            }
        });

    } else {
        answer = [];
        tmpAnswer = {};
        count = 0;
    }
}

